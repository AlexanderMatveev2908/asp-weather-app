name: ğŸ§ª check && deploy ğŸš€

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: ğŸ§ª check ğŸ§ª
    runs-on: ubuntu-latest

    env:
      ASP_WEATHER_APP__SERVER: ${{secrets.ASP_WEATHER_APP__SERVER}}
      ASP_WEATHER_APP__CLIENT: ${{secrets.ASP_WEATHER_APP__CLIENT}}
      APP_NAME: ${{secrets.APP_NAME}}
      ENV_MODE: "test"
      BACK_URL: ${{secrets.BACK_URL}}
      BACK_URL_DEV: ${{secrets.BACK_URL_DEV}}
      FRONT_URL: ${{secrets.FRONT_URL}}
      FRONT_URL_DEV: ${{secrets.FRONT_URL_DEV}}
      BACK_URL_TEST: ${{secrets.BACK_URL_TEST}}
      FRONT_URL_TEST: ${{secrets.FRONT_URL_TEST}}
      REDIS_URL: ${{secrets.REDIS_URL}}
      CLOUD_NAME: ${{secrets.CLOUD_NAME}}
      CLOUD_API_KEY: ${{secrets.CLOUD_API_KEY}}
      CLOUD_API_SECRET: ${{secrets.CLOUD_API_SECRET}}
      WEATHER_API_KEY: ${{secrets.WEATHER_API_KEY}}

    steps:
      - name: ğŸ“‚ clone code
        uses: actions/checkout@v4

      - name: ğŸŸ© setup node && yarn
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ”§ enable corepack && set yarn version berry
        run: |
          corepack enable
          corepack prepare yarn@4.9.2 --activate

      - name: ğŸ—ƒï¸ yarn cache
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      - name: ğŸ“¦ install client pkg
        run: yarn install && yarn workspace client install_pkg

      - name: â˜• setup Java 21 Eclipse
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: ğŸ”§ make gradlew executable
        run: chmod +x apps/server/gradlew

      - name: ğŸ” lint && types check
        run: yarn check

      - name: ğŸ”’ generate .env client & server workspaces
        run: printenv > apps/client/.env & printenv > apps/server/.env

      - name: ğŸ› ï¸ build app
        run: yarn build:test

      - name: â³ start servers & wait
        run: |
          set -euo pipefail
          yarn start &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          yarn dlx wait-on \
            --timeout $((1000 * 30)) \
            http-get://localhost:3000/api/v1/test \
            http-get://localhost:3001

      - name: ğŸ’» run test client
        run: yarn workspace client test

      - name: ğŸ›‘ stop server
        run: kill $SERVER_PID || true

      - name: â˜• run test server
        run: yarn workspace server test

  deploy:
    name: ğŸš€ deploy server && client ğŸš€
    needs: [check]
    if: github.event_name == 'push' && needs.check.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ clone code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ install fly CLI lib
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: â˜• deploy server
        working-directory: apps/server
        run: flyctl deploy --remote-only --config fly.toml
        env:
          FLY_API_TOKEN: ${{ secrets.ASP_WEATHER_APP__SERVER }}

      - name: ğŸ’» deploy client
        working-directory: apps/client
        run: |
          flyctl deploy \
            --remote-only \
            --config fly.toml \
            --build-arg ENV_MODE=${{ secrets.ENV_MODE }} \
            --build-arg FRONT_URL=${{ secrets.FRONT_URL }} \
            --build-arg BACK_URL=${{ secrets.BACK_URL }}
        env:
          FLY_API_TOKEN: ${{ secrets.ASP_WEATHER_APP__CLIENT }}
